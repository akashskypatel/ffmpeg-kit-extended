// bin/configure.dart
import 'dart:io';
import 'package:path/path.dart' as p;
import 'package:yaml/yaml.dart';

// =============================================================================
// RELEASE CONFIGURATION
// =============================================================================

// Base URL for where your release artifacts are hosted.
// Update this to point to your actual release/hosting location.
const String _baseUrl =
    "https://github.com/akashskypatel/ffmpeg-kit-builders/releases/download/v8.0";

// Map logical bundle names to specific filenames.
// The script will append this filename to _baseUrl.
const Map<String, String> _linuxX64Bundles = {
  'audio': 'bundle-audio-linux-x86_64-static.zip',
  'audio-ai': 'bundle-audio-ai-linux-x86_64-static.zip',
  'video': 'bundle-video-linux-x86_64-static.zip',
  'video-ai-cpu': 'bundle-video_ai_cpu-linux-x86_64-static.zip',
  'video-ai-gpu-cuda': 'bundle-video_ai_gpu_cuda-linux-x86_64-static.zip',
  'video-ai-gpu-rocm': 'bundle-video_ai_gpu_rocm-linux-x86_64-static.zip',
  'video-hw': 'bundle-video_hw-linux-x86_64-static.zip',
  'video-hw-ai-gpu-cuda': 'bundle-video_hw_ai_gpu_cuda-linux-x86_64-static.zip',
  'video-hw-ai-gpu-rocm': 'bundle-video_hw_ai_gpu_rocm-linux-x86_64-static.zip',
  'streaming': 'bundle-streaming-linux-x86_64-static.zip',
  'full': 'bundle-full-linux-x86_64-static.zip',
};

// =============================================================================
// LOGIC
// =============================================================================

void main(List<String> args) {
  print('FFmpegKit: Configuring platform specifics...');

  final pubspecFile = File('pubspec.yaml');
  if (!pubspecFile.existsSync()) {
    print(
        'Error: pubspec.yaml not found. Run this from your Flutter project root.');
    exit(1);
  }

  final content = pubspecFile.readAsStringSync();
  final doc = loadYaml(content);

  if (doc['ffmpeg_kit_config'] == null) {
    print('FFmpegKit: No "ffmpeg_kit_config" section found. Using default.');
    _cleanConfig();
    return;
  }

  final config = doc['ffmpeg_kit_config'];
  _configureLinux(config);

  print('FFmpegKit: Configuration completed.');
}

void _cleanConfig() {
  final linuxConfig = File('linux/config.cmake');
  if (linuxConfig.existsSync()) {
    linuxConfig.deleteSync();
    print('FFmpegKit: Cleaned old Linux configuration.');
  }
}

void _configureLinux(dynamic config) {
  final linuxDir = Directory('linux');
  if (!linuxDir.existsSync()) return;

  final buffer = StringBuffer();
  buffer.writeln('# Generated by ffmpeg_kit_flutter:configure');
  buffer.writeln('# Do not edit this file directly.');
  buffer.writeln();

  bool configFound = false;

  // 1. Explicit Path (Local Override)
  if (config['path'] != null) {
    final rawPath = config['path'];
    final absPath = p.absolute(rawPath).replaceAll(r'\', '/');

    // Check if it's an archive or a directory
    if (rawPath.endsWith('.zip') ||
        rawPath.endsWith('.tar') ||
        rawPath.endsWith('.tar.gz')) {
      buffer.writeln(
          'set(FFMPEG_KIT_Config_Url "$absPath" CACHE STRING "Local Archive" FORCE)');
      print('FFmpegKit (Linux): Configured local archive -> $rawPath');
    } else {
      buffer.writeln(
          'set(FFMPEG_KIT_Config_Path "$absPath" CACHE STRING "Custom Path" FORCE)');
      print('FFmpegKit (Linux): Configured local path -> $rawPath');
    }
    configFound = true;
  }
  // 2. Explicit URL (Manual Override)
  else if (config['url'] != null) {
    final url = config['url'];
    buffer.writeln(
        'set(FFMPEG_KIT_Config_Url "$url" CACHE STRING "Remote URL" FORCE)');
    print('FFmpegKit (Linux): Configured remote URL -> $url');
    configFound = true;
  }
  // 3. Named Bundle (Automatic Remote Resolution)
  else if (config['bundle'] != null) {
    final bundleName = config['bundle'];

    // Detect Host/Target Architecture
    // For now, simpler detection. Cross-compilation from arm64->x64 is rare for Linux desktop
    // but possible. Defaults to x86_64 map.
    final filename = _linuxX64Bundles[bundleName] ?? '';

    if (filename.isNotEmpty) {
      final url = "$_baseUrl/$filename";
      buffer.writeln(
          'set(FFMPEG_KIT_Config_Url "$url" CACHE STRING "Bundle URL" FORCE)');
      print('FFmpegKit (Linux): Resolved bundle "$bundleName"');
      print('                   Downloading from: $url');
      configFound = true;
    } else {
      print(
          'FFmpegKit (Linux): Error - Bundle "$bundleName" not recognized for Linux x86_64.');
      print(
          '                   Available bundles: ${_linuxX64Bundles.keys.join(", ")}');
    }
  }

  if (configFound) {
    File('linux/config.cmake').writeAsStringSync(buffer.toString());
  } else {
    _cleanConfig();
  }
}
